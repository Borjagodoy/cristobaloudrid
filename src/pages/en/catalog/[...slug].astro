---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import MembershipCard from "../../../components/MembershipCard.astro";
import MediaGallery from "../../../components/MediaGallery.astro";

export async function getStaticPaths() {
    const obras = await getCollection("obras");
    return obras
        .filter((entry) => entry.id.startsWith("en/"))
        .map((entry) => ({
            params: { slug: entry.slug.split("/").pop() }, // remove 'en/' prefix
            props: { entry },
        }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const {
    titulo,
    anio,
    genero,
    estado,
    es_edicion_critica,
    creditos,
    archivos,
    multimedia,
} = entry.data;

const statusColor =
    estado === "disponible" ? "text-green-600" : "text-yellow-600";
const statusLabel = {
    disponible: "Available",
    en_recuperacion: "In Recovery",
    no_catalogado: "Uncataloged",
}[estado];
---

<Layout
    title={`${titulo} - Oudrid Catalog`}
    description={`Score and information for ${titulo}.`}
    lang="en"
>
    <main class="py-20 px-6 max-w-4xl mx-auto">
        <!-- Breadcrumb -->
        <nav class="mb-8 text-sm font-sans text-ink/50">
            <a href="/en/catalog" class="hover:text-accent-red">Catalog</a>
            <span class="mx-2">/</span>
            <span class="text-ink">{titulo}</span>
        </nav>

        <!-- Header -->
        <header class="mb-12 border-b-2 border-accent-gold/20 pb-12">
            <div
                class="flex flex-col md:flex-row md:items-start md:justify-between gap-6"
            >
                <div>
                    <div class="flex items-center gap-3 mb-4">
                        <span
                            class="px-3 py-1 bg-ink/5 text-ink text-xs font-bold uppercase tracking-wider rounded-full"
                        >
                            {genero}
                        </span>
                        <span
                            class={`font-bold text-sm flex items-center gap-1 ${statusColor}`}
                        >
                            <!-- Status Icon -->
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                class="h-4 w-4"
                                aria-hidden="true"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L9.414 11H13a1 1 0 100-2H9.414l1.293-1.293z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            {statusLabel}
                        </span>
                    </div>
                    <h1
                        class="text-5xl md:text-6xl font-serif font-bold text-ink mb-2"
                    >
                        {titulo}
                    </h1>
                    <p class="text-2xl font-serif text-ink/60 italic">{anio}</p>
                </div>

                {
                    es_edicion_critica && (
                        <div class="bg-accent-gold/10 border border-accent-gold/30 p-4 rounded-sm max-w-xs">
                            <div class="flex items-center gap-2 text-accent-gold font-bold mb-1">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                    class="w-5 h-5"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z"
                                        clip-rule="evenodd"
                                    />
                                </svg>
                                Critical Edition
                            </div>
                            <p class="text-sm text-ink/80">
                                {creditos || "Technical review guaranteed"}
                            </p>
                        </div>
                    )
                }
            </div>
        </header>

        <div class="grid md:grid-cols-3 gap-12">
            <!-- Main Content -->
            <article
                class="md:col-span-2 prose prose-stone prose-lg prose-headings:font-serif prose-headings:text-ink prose-a:text-accent-red"
            >
                <Content />
                {
                    multimedia && (
                        <div class="pt-12 border-t border-ink/10">
                            <MediaGallery media={multimedia} />
                        </div>
                    )
                }
            </article>

            <!-- Sidebar / CTA -->
            <aside class="space-y-8">
                {
                    estado === "disponible" ? (
                        <div class="space-y-8">
                            <div class="bg-paper border border-ink/10 p-6 rounded-sm shadow-sm">
                                <h3 class="font-serif font-bold text-xl mb-4 text-ink">
                                    Downloads
                                </h3>
                                <div class="space-y-3">
                                    {archivos?.partitura && (
                                        <a
                                            href={archivos.partitura}
                                            target="_blank"
                                            class="flex items-center gap-3 w-full p-3 bg-ink/5 hover:bg-ink/10 transition-colors rounded-sm group"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke-width="1.5"
                                                stroke="currentColor"
                                                class="size-6 text-accent-red group-hover:scale-110 transition-transform"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"
                                                />
                                            </svg>
                                            <span class="font-bold text-sm">
                                                Full Score (PDF)
                                            </span>
                                        </a>
                                    )}
                                    {archivos?.libreto && (
                                        <a
                                            href={archivos.libreto}
                                            target="_blank"
                                            class="flex items-center gap-3 w-full p-3 bg-ink/5 hover:bg-ink/10 transition-colors rounded-sm group"
                                        >
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke-width="1.5"
                                                stroke="currentColor"
                                                class="size-6 text-ink/50 group-hover:text-ink transition-colors"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"
                                                />
                                            </svg>
                                            <span class="font-bold text-sm">
                                                Libretto (PDF)
                                            </span>
                                        </a>
                                    )}
                                </div>
                            </div>
                            <MembershipCard
                                title="Support our work"
                                ctaText="Become a Member"
                                isAvailable={true}
                            />
                        </div>
                    ) : (
                        <MembershipCard
                            title="Work in Recovery"
                            ctaText="Fund this work"
                            unavailableMessage="This work is pending edition. Your membership fee makes it possible for us to rescue these scores from oblivion."
                            isAvailable={false}
                        />
                    )
                }
            </aside>
        </div>
    </main>
</Layout>
