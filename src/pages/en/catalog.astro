---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const allObras = await getCollection("obras");
// Filter for English content
const obras = allObras.filter((obra) => obra.id.startsWith("en/"));

// Sort by Title
obras.sort((a, b) => a.data.titulo.localeCompare(b.data.titulo));

const statusMap = {
    disponible: { label: "Available", color: "bg-green-100 text-green-800" },
    en_recuperacion: {
        label: "In Recovery",
        color: "bg-yellow-100 text-yellow-800",
    },
    no_catalogado: { label: "Uncataloged", color: "bg-gray-100 text-gray-800" },
};
---

<Layout
    title="Master Catalog - Cristobal Oudrid Association"
    description="Complete catalog of works by Cristobal Oudrid."
    lang="en"
>
    <main class="py-16 px-6 max-w-6xl mx-auto">
        <header class="mb-12">
            <h1 class="text-4xl md:text-5xl font-serif font-bold text-ink mb-4">
                Work Catalog
            </h1>
            <p class="text-lg font-light text-ink/70">
                Explore the complete musical legacy. Use the search bar to
                filter.
            </p>
        </header>

        <!-- Search Input -->
        <div class="mb-8 relative max-w-md">
            <div
                class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
                <!-- Search Icon SVG -->
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                    class="w-5 h-5 text-gray-400"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
                    ></path>
                </svg>
            </div>
            <input
                type="text"
                id="buscador"
                placeholder="Search by title, genre..."
                class="block w-full pl-10 pr-3 py-3 border border-gray-300 rounded-sm leading-5 bg-paper placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:border-accent-red focus:ring-1 focus:ring-accent-red sm:text-sm transition duration-150 ease-in-out"
            />
        </div>

        <!-- Master Table -->
        <div
            class="overflow-x-auto shadow-sm border border-gray-200 rounded-sm"
        >
            <table class="min-w-full divide-y divide-gray-200" id="tabla-obras">
                <thead class="bg-gray-50">
                    <tr>
                        <th
                            scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                            >Title</th
                        >
                        <th
                            scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                            >Year</th
                        >
                        <th
                            scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                            >Genre</th
                        >
                        <th
                            scope="col"
                            class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
                            >Status</th
                        >
                        <th scope="col" class="relative px-6 py-3">
                            <span class="sr-only">View</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {
                        obras.map((obra, index) => {
                            const status = statusMap[obra.data.estado];
                            // remove 'en/' from slug
                            const url = `/en/catalog/${obra.slug.split("/").pop()}`;
                            return (
                                <tr
                                    class="hover:bg-gray-50 transition-colors duration-150 group animate-fade-in-up opacity-0"
                                    style={`animation-delay: ${index * 100}ms`}
                                >
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-serif font-bold text-ink">
                                            {obra.data.titulo}
                                        </div>
                                        {obra.data.es_edicion_critica && (
                                            <div class="flex items-center mt-1 text-xs text-accent-gold font-bold">
                                                <svg
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 20 20"
                                                    fill="currentColor"
                                                    class="w-3 h-3 mr-1"
                                                >
                                                    <path
                                                        fill-rule="evenodd"
                                                        d="M10.868 2.884c-.321-.772-1.415-.772-1.736 0l-1.83 4.401-4.753.381c-.833.067-1.171 1.107-.536 1.651l3.62 3.102-1.106 4.637c-.194.813.691 1.456 1.405 1.02L10 15.591l4.069 2.485c.713.436 1.598-.207 1.404-1.02l-1.106-4.637 3.62-3.102c.635-.544.297-1.584-.536-1.65l-4.752-.382-1.831-4.401Z"
                                                        clip-rule="evenodd"
                                                    />
                                                </svg>
                                                Critical Edition
                                            </div>
                                        )}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {obra.data.anio}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                            {obra.data.genero}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span
                                            class={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status.color}`}
                                        >
                                            {status.label}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <a
                                            href={url}
                                            class="text-accent-red hover:text-accent-gold transition-colors font-bold"
                                        >
                                            View â†’
                                        </a>
                                    </td>
                                </tr>
                            );
                        })
                    }
                </tbody>
            </table>
        </div>

        <!-- Vanilla JS Search Script -->
        <script is:inline>
            const buscador = document.getElementById("buscador");
            const tabla = document.getElementById("tabla-obras");
            const filas = tabla.getElementsByTagName("tr");

            buscador.addEventListener("input", function (e) {
                const term = e.target.value.toLowerCase();

                // Start from 1 to skip header row
                for (let i = 1; i < filas.length; i++) {
                    const fila = filas[i];
                    const textoFila = fila.textContent.toLowerCase();

                    if (textoFila.includes(term)) {
                        fila.style.display = "";
                    } else {
                        fila.style.display = "none";
                    }
                }
            });
        </script>
    </main>
</Layout>
